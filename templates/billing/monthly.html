{% extends "base.html" %}
{% block title %}Mensalidades{% endblock %}
{% block content %}
<div class="page-shell">
    <div class="page-head">
        <div>
            <h2>Mensalidades</h2>
            <div class="muted">Regra: vencimento 30 dias apos cadastro, aviso 2 dias antes.</div>
        </div>
        <div class="inline-actions">
            <span class="chip">Fila pendente: {{ queue_pending }}</span>
            <span class="chip">Fila erro: {{ queue_error }}</span>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Vencendo em 2 dias</div>
            <div class="kpi-value">{{ due_soon_clients }}</div>
            <div class="kpi-note">Clientes com vencimento proximo</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Pagos no mes</div>
            <div class="kpi-value">{{ paid_clients }}</div>
            <div class="kpi-note">Mensalidades compensadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Pendentes no mes</div>
            <div class="kpi-value">{{ pending_clients }}</div>
            <div class="kpi-note">Aguardando pagamento</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Em atraso</div>
            <div class="kpi-value" style="color:#ff9a9a;">{{ overdue_clients_count }}</div>
            <div class="kpi-note">Necessita lembrete</div>
        </div>
    </div>

    <div class="card">
        <h3>Clientes vencendo em 2 dias</h3>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Telefone</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in due_soon_list %}
                    <tr>
                        <td>{{ item.client.name }}</td>
                        <td>{{ item.client.phone|default:"-" }}</td>
                        <td>{{ item.due_date }}</td>
                        <td><span class="badge success">Previsto</span></td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">Nenhum vencimento previsto para daqui 2 dias.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="page-head">
            <h3>Gerenciar envios</h3>
            <div class="muted">Boletos enviados no dia do vencimento.</div>
        </div>
        <div class="inline-actions" style="margin-bottom:8px;">
            <span class="badge success">Boleto do dia</span>
            <span class="badge danger">Atrasado</span>
        </div>
        <form method="post" action="{% url 'run_monthly_billing' %}">
            {% csrf_token %}
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
                <div>
                    <label>Intervalo de envio (seg)</label>
                    <input type="number" name="delay" value="4" step="0.5" min="0">
                </div>
            </div>
            <div class="inline-actions" style="margin-top:10px;">
                <label style="display:inline-flex; align-items:center; gap:8px; margin:0;">
                    <input type="checkbox" name="create_new" checked>
                    Gerar boletos do dia
                </label>
                <label style="display:inline-flex; align-items:center; gap:8px; margin:0;">
                    <input type="checkbox" name="send_reminders">
                    Enviar lembretes de atrasados
                </label>
            </div>
            <div class="page-actions" style="margin-top:12px;">
                <button class="btn secondary" type="submit" name="action" value="generate">Gerar boletos</button>
                <button class="btn" type="submit" name="action" value="generate_send" onclick="return confirm('Gerar boletos de hoje e enviar WhatsApp agora?');">Gerar e enviar WhatsApp</button>
                <button class="btn secondary" type="submit" name="action" value="send_queue" onclick="return confirm('Enviar fila WhatsApp agora?');">Enviar fila WhatsApp</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
