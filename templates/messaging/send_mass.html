{% extends "base.html" %}
{% block title %}Envio em Massa{% endblock %}
{% block content %}
<div class="page-shell">
    <div class="page-head">
        <div>
            <h2>Envio em Massa</h2>
            <div class="muted">Gere cobrancas em lote e acompanhe fila de envio.</div>
        </div>
    </div>

    <div class="card">
        <form method="post" id="mass-form">
            {% csrf_token %}
            <div class="inline-actions">
                <label style="margin:0; display:inline-flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="select-all" name="select_all" {% if form.select_all.value %}checked{% endif %}>
                    Selecionar todos os clientes
                </label>
            </div>
            <label>Clientes</label>
            {{ form.clients }}
            <div class="chips" id="clients-chips"></div>
            <label>Template</label>
            {{ form.template }}
            <label>Valor (opcional)</label>
            {{ form.amount }}
            <label>Vencimento (opcional)</label>
            {{ form.due_date }}
            <div class="page-actions">
                <button class="btn" type="submit">Gerar cobrancas e enfileirar</button>
            </div>
        </form>
    </div>

    <div class="card">
        <div class="page-head">
            <h3>Fila recente</h3>
            <form method="post" action="{% url 'queue_clear' %}" onsubmit="return confirm('Deseja limpar toda a fila?');">
                {% csrf_token %}
                <button class="btn secondary" type="submit">Limpar fila</button>
            </form>
        </div>
        <div class="inline-actions" style="margin:10px 0;">
            <button class="btn" type="button" id="send-now-btn">Enviar fila agora (WhatsApp)</button>
            <span id="send-now-status" class="muted"></span>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Status</th>
                        <th>Ultima tentativa</th>
                        <th>Erro</th>
                        <th>Acoes</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in queue %}
                    <tr>
                        <td>{{ item.client.name }}</td>
                        <td>{{ item.get_status_display }}</td>
                        <td>{{ item.sent_at|default:"-" }}</td>
                        <td>{% if item.status == 'error' %}{{ item.error_message|default:"(sem detalhes)" }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" action="{% url 'queue_delete' item.id %}" onsubmit="return confirm('Remover este item da fila?');">
                                {% csrf_token %}
                                <button class="btn secondary" type="submit">Remover</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">Nenhuma mensagem enfileirada.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const selectAllCheckbox = document.getElementById('select-all');
const clientsSelect = document.getElementById('{{ form.clients.id_for_label }}');
const chips = document.getElementById('clients-chips');
selectAllCheckbox.addEventListener('change', () => {
    const opts = clientsSelect && clientsSelect.options;
    if (!opts) return;
    for (let i = 0; i < opts.length; i++) {
        opts[i].selected = selectAllCheckbox.checked;
    }
    renderChips();
});

function renderChips() {
    if (!clientsSelect || !chips) return;
    chips.innerHTML = '';
    const opts = clientsSelect.options;
    for (let i = 0; i < opts.length; i++) {
        if (opts[i].selected) {
            const div = document.createElement('div');
            div.className = 'chip';
            div.textContent = opts[i].textContent.trim();
            chips.appendChild(div);
        }
    }
}
clientsSelect && clientsSelect.addEventListener('change', renderChips);
renderChips();
</script>

<form id="csrf-send-now">{% csrf_token %}</form>
<script>
const sendBtn = document.getElementById('send-now-btn');
const sendStatus = document.getElementById('send-now-status');
const csrfTokenSend = document.querySelector('#csrf-send-now input[name=csrfmiddlewaretoken]').value;
sendBtn.addEventListener('click', async () => {
    sendStatus.textContent = 'Iniciando envio...';
    try {
        const res = await fetch('{% url "whatsapp_send_now" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': csrfTokenSend},
        });
        const data = await res.json();
        sendStatus.textContent = data.message || 'Envio iniciado';
    } catch (err) {
        sendStatus.textContent = 'Erro: ' + err.message;
    }
});
</script>
{% endblock %}
