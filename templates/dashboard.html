{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="page-shell">
    <div class="page-head">
        <div>
            <h1>Resumo Geral</h1>
            <div class="muted">Visao financeira, operacao de cobrancas e desempenho de vendedores.</div>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Em caixa</div>
            <div class="kpi-value">R$ {{ total_received|floatformat:2 }}</div>
            <div class="kpi-note">Total de faturas pagas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">A receber</div>
            <div class="kpi-value">R$ {{ total_to_receive|floatformat:2 }}</div>
            <div class="kpi-note">Faturas pendentes</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">WhatsApp (30 dias)</div>
            <div class="inline-actions" style="margin-top:6px;">
                <span class="badge success">Enviados: {{ total_sent }}</span>
                <span class="badge">Pendentes: {{ total_pending_queue }}</span>
                <span class="badge danger">Erros: {{ total_error_queue }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Comissoes de Vendedores</h3>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Vendedor</th>
                        <th>Boletos</th>
                        <th>Total em boletos</th>
                        <th>Pagos</th>
                        <th>Comissao a receber</th>
                        <th>Comissao pendente</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in seller_commissions %}
                    <tr>
                        <td>{{ row.seller.name }}</td>
                        <td>{{ row.total_count }}</td>
                        <td>R$ {{ row.total_sum|floatformat:2 }}</td>
                        <td>R$ {{ row.paid_sum|floatformat:2 }}</td>
                        <td>R$ {{ row.commission_due|floatformat:2 }}</td>
                        <td>R$ {{ row.commission_pending|floatformat:2 }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6">Nenhum vendedor ativo.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="page-head">
            <h3>Clientes Inadimplentes</h3>
            <div class="page-actions">
                <form method="post" action="{% url 'reset_finance' %}" onsubmit="return confirm('Deseja zerar cobrancas e fila?');">
                    {% csrf_token %}
                    <button class="btn secondary" type="submit">Zerar financeiro</button>
                </form>
                <a href="{% url 'send_mass_messages' %}" class="btn secondary">Reenviar cobrancas</a>
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Acao</th>
                    </tr>
                </thead>
                <tbody>
                {% for bill in overdue_clients %}
                    <tr>
                        <td>{{ bill.client.name }}</td>
                        <td>R$ {{ bill.amount|floatformat:2 }}</td>
                        <td>{{ bill.due_date }}</td>
                        <td><span class="badge danger">Atrasado</span></td>
                        <td><a class="btn secondary" href="{% url 'invoice_single_client' bill.client.id %}">Reenviar</a></td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">Nenhum inadimplente.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
