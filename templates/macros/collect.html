{% extends "base.html" %}
{% block title %}Macros - Coleta local{% endblock %}
{% block extra_head %}
<style>
    .macro-page { display: grid; gap: 14px; }
    .macro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .macro-title-wrap { display: flex; align-items: center; gap: 8px; }
    .macro-tag { font-size: 11px; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 3px 8px; }
    .macro-nav { display: flex; gap: 8px; flex-wrap: wrap; }
    .macro-nav .tab {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 12px;
        color: var(--muted);
        background: rgba(255,255,255,0.02);
    }
    .macro-nav .tab.active {
        color: #07111f;
        border-color: transparent;
        background: var(--accent);
        font-weight: 600;
    }
    .macro-orbit {
        --orbit-surface: rgba(22, 22, 22, 0.9);
        position: relative;
        isolation: isolate;
        overflow: hidden;
        border: 1px solid transparent !important;
    }
    .macro-orbit::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        background: conic-gradient(
            from 0deg,
            rgba(255, 132, 36, 0) 0deg,
            rgba(255, 132, 36, 0) 300deg,
            rgba(255, 132, 36, 0.95) 330deg,
            rgba(255, 132, 36, 0) 360deg
        );
        animation: macro-orbit-spin 2.6s linear infinite;
        z-index: -2;
    }
    .macro-orbit::after {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: inherit;
        background: var(--orbit-surface);
        z-index: -1;
    }
    .macro-nav .tab.macro-orbit {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .macro-nav .tab.macro-orbit.active {
        --orbit-surface: linear-gradient(180deg, #ff912e, #f97316);
        color: #091018;
        font-weight: 700;
    }
    .btn.macro-orbit {
        box-shadow: none;
        background: transparent !important;
    }
    .btn.secondary.macro-orbit {
        color: #efe8df;
    }
    .btn.macro-orbit:not(.secondary) {
        --orbit-surface: linear-gradient(180deg, #ff912e, #f97316);
        color: #fff;
    }
    @keyframes macro-orbit-spin {
        to { transform: rotate(1turn); }
    }
    .macro-muted { color: var(--muted); margin: 0; }
    .macro-steps { display: grid; gap: 8px; margin: 12px 0; }
    .macro-step { display: flex; gap: 10px; align-items: center; color: var(--muted); }
    .macro-step b {
        width: 22px; height: 22px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center;
        background: rgba(43, 179, 227, 0.16); border: 1px solid rgba(43, 179, 227, 0.35); color: var(--text); font-size: 12px;
    }
    .macro-main-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .macro-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .macro-kpi { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: rgba(15, 23, 37, 0.5); }
    .macro-kpi-label { color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .macro-kpi-value { font-size: 20px; font-weight: 600; }
    .macro-kpi-note { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .macro-danger-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
    .macro-danger-box { border: 1px dashed rgba(255, 107, 107, 0.45); border-radius: 12px; padding: 10px; }
    .macro-danger-title { margin: 0 0 6px; color: #ffb3b3; font-size: 13px; font-weight: 600; }
    .macro-danger-help { margin: 0 0 8px; color: var(--muted); font-size: 12px; }
    .macro-inline-form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .macro-inline-form input { width: auto; min-width: 150px; }
    .version-alert {
        border: 1px solid rgba(255, 195, 77, 0.45);
        background: linear-gradient(120deg, rgba(255, 195, 77, 0.2), rgba(15, 23, 37, 0.95));
        border-radius: 12px;
        padding: 12px;
        display: none;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    .version-alert.show { display: flex; }
    .version-alert strong { color: #ffd894; }
    .version-alert p { margin: 0; color: #ffe7bf; }
    .version-ok {
        border: 1px solid rgba(75,214,176,0.35);
        background: rgba(75,214,176,0.1);
        border-radius: 12px;
        padding: 10px 12px;
        display: none;
        color: #9df2dc;
    }
    .version-ok.show { display: block; }
</style>
{% endblock %}
{% block content %}
<div class="macro-page">
    <div class="macro-header">
        <div class="macro-title-wrap">
            <h2 style="margin:0;">Macros - Coleta local</h2>
            <span class="macro-tag">{{ macro_agent_label }}</span>
        </div>
        <div class="macro-nav">
            <a class="tab macro-orbit {% if active_tab == 'database' %}active{% endif %}" href="{% url 'macro_list' %}">Banco de dados</a>
            <a class="tab macro-orbit {% if active_tab == 'collect' %}active{% endif %}" href="{% url 'macro_collect' %}">Coleta local</a>
        </div>
    </div>

    <div id="versionAlert" class="version-alert">
        <p><strong>NOVA VERSAO DISPONIVEL:</strong> baixe novamente o Coletor (EXE) para usar a versao <b>{{ macro_agent_label }}</b>.</p>
        <button id="markVersionBtn" class="btn secondary macro-orbit" type="button">Ja baixei esta versao</button>
    </div>
    <div id="versionOk" class="version-ok">
        Coletor local atualizado para a versao {{ macro_agent_label }} neste navegador.
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Coleta por botoes</h3>
        <p class="macro-muted">Tudo separado da tela de banco de dados para ficar mais simples.</p>
        <div class="macro-steps">
            <div class="macro-step"><b>1</b><span>Baixe e execute o Coletor (EXE ou macOS) no computador da coleta.</span></div>
            <div class="macro-step"><b>2</b><span>Clique em Abrir painel local e depois em Abrir pagina alvo.</span></div>
            <div class="macro-step"><b>3</b><span>Faca login/filtro no portal e clique em Comecar coleta no painel local.</span></div>
        </div>
        <div class="macro-main-actions">
            <a class="btn macro-orbit" href="{{ local_agent_url }}?api_url={{ api_import_url|urlencode }}&target_url={{ macro_target_url|urlencode }}" target="_blank" rel="noopener">Abrir painel local</a>
            <a class="btn secondary macro-orbit js-download-agent" href="{% url 'macro_download_local_agent_exe' %}">Baixar Coletor (EXE)</a>
            <a class="btn secondary macro-orbit js-download-agent" href="{% url 'macro_download_local_agent_mac' %}">Baixar Coletor (macOS)</a>
        </div>
        <p style="margin:10px 0 0;color:var(--muted);">Versao do coletor: {{ macro_agent_label }}</p>
        {% if not local_agent_exe_available %}
            <p style="margin:10px 0 0;color:#ffb86b;">EXE ainda nao disponivel neste servidor.</p>
        {% endif %}
        <details style="margin-top:12px;">
            <summary style="cursor:pointer;color:var(--muted);">Mostrar detalhes tecnicos</summary>
            <code style="display:block;word-break:break-all;margin-top:8px;">{{ api_import_url }}</code>
            {% if token_configured %}
                <p style="margin:8px 0 0;color:var(--muted);">Token de API configurado no sistema.</p>
            {% else %}
                <p style="margin:8px 0 0;color:#ff6b6b;">MACRO_API_TOKEN nao configurado no .env.</p>
            {% endif %}
        </details>
    </div>

    <div class="macro-kpis">
        <div class="macro-kpi">
            <div class="macro-kpi-label">Leads no banco</div>
            <div class="macro-kpi-value">{{ total_records }}</div>
            <div class="macro-kpi-note">Total pronto para filtro/exportacao</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Ultima captura</div>
            <div class="macro-kpi-value">
                {% if last_capture_at %}
                    {{ last_capture_at|date:"d/m/Y H:i" }}
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Execucoes (24h)</div>
            <div class="macro-kpi-value">{{ runs_24h_total }}</div>
            <div class="macro-kpi-note">Erros nas ultimas 24h: {{ runs_24h_error }}</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Ultima execucao com sucesso</div>
            <div class="macro-kpi-value">
                {% if last_success_run %}
                    {{ last_success_run.started_at|date:"d/m H:i" }}
                {% else %}
                    --
                {% endif %}
            </div>
            <div class="macro-kpi-note">
                {% if last_error_run %}
                    Ultimo erro: {{ last_error_run.started_at|date:"d/m H:i" }}
                {% else %}
                    Sem erros recentes
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Limpeza rapida</h3>
        <div class="macro-danger-grid">
            <div class="macro-danger-box">
                <div class="macro-danger-title">Limpar historico de execucoes</div>
                <p class="macro-danger-help">Digite <b>LIMPAR HISTORICO</b> para apagar os logs antigos.</p>
                <form method="post" action="{% url 'macro_delete_runs' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="collect">
                    <input type="text" name="confirm_text" placeholder="LIMPAR HISTORICO" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Limpar historico de execucoes agora?')">Limpar historico</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Apagar toda base de leads</div>
                <p class="macro-danger-help">Digite <b>APAGAR TUDO</b> para limpar o banco completo.</p>
                <form method="post" action="{% url 'macro_delete_all' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="collect">
                    <input type="text" name="confirm_text" placeholder="APAGAR TUDO" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Apagar toda a base de leads?')">Apagar base</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Excluir base especifica</div>
                <p class="macro-danger-help">Escolha a fonte e opcionalmente cidade. Digite <b>EXCLUIR BASE</b>.</p>
                <form method="post" action="{% url 'macro_delete_source' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="collect">
                    <select name="source" required style="width:auto;min-width:140px;">
                        <option value="">Fonte</option>
                        {% for source in sources %}
                            <option value="{{ source }}">{{ source }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="city" placeholder="Cidade (opcional)">
                    <input type="text" name="confirm_text" placeholder="EXCLUIR BASE" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Excluir base especifica agora?')">Excluir base especifica</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Historico de execucoes</h3>
        <table>
            <thead>
                <tr>
                    <th>Inicio</th>
                    <th>Tipo</th>
                    <th>Status</th>
                    <th>Coletados</th>
                    <th>Unicos</th>
                    <th>Enviados</th>
                    <th>Novos</th>
                    <th>Atualizados</th>
                    <th>Paginas</th>
                    <th>IP</th>
                    <th>Mensagem</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody>
            {% for run in recent_runs %}
                <tr>
                    <td>{{ run.started_at|date:"d/m/Y H:i" }}</td>
                    <td>{{ run.get_run_type_display }}</td>
                    <td>{{ run.get_status_display }}</td>
                    <td>{{ run.total_collected }}</td>
                    <td>{% if run.total_deduplicated %}{{ run.total_deduplicated }}{% else %}{{ run.total_received }}{% endif %}</td>
                    <td>{% if run.total_sent %}{{ run.total_sent }}{% else %}{{ run.total_received }}{% endif %}</td>
                    <td>{{ run.created_count }}</td>
                    <td>{{ run.updated_count }}</td>
                    <td>{{ run.pages_processed|default:"0" }}</td>
                    <td>{{ run.request_ip|default:"-" }}</td>
                    <td>{{ run.message|default:"-" }}</td>
                    <td>
                        <form method="post" action="{% url 'macro_delete_run_item' run.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="collect">
                            <button class="btn danger" type="submit" onclick="return confirm('Excluir esta execucao do historico?')">Excluir</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="12">Sem execucoes ainda.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
(() => {
    const currentVersion = "{{ macro_agent_label|escapejs }}";
    const storageKey = "macro_agent_downloaded_version";
    const versionAlert = document.getElementById("versionAlert");
    const versionOk = document.getElementById("versionOk");
    const markBtn = document.getElementById("markVersionBtn");
    const downloadLinks = document.querySelectorAll(".js-download-agent");

    if (!currentVersion) {
        return;
    }

    const savedVersion = localStorage.getItem(storageKey) || "";
    const needsDownload = savedVersion !== currentVersion;

    if (needsDownload) {
        versionAlert.classList.add("show");
        versionOk.classList.remove("show");
    } else {
        versionOk.classList.add("show");
        versionAlert.classList.remove("show");
    }

    const markCurrentVersion = () => {
        localStorage.setItem(storageKey, currentVersion);
        versionAlert.classList.remove("show");
        versionOk.classList.add("show");
    };

    if (markBtn) {
        markBtn.addEventListener("click", markCurrentVersion);
    }
    downloadLinks.forEach((link) => {
        link.addEventListener("click", markCurrentVersion);
    });
})();
</script>
{% endblock %}
