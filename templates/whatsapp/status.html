{% extends "base.html" %}
{% block title %}WhatsApp{% endblock %}
{% block content %}
<div class="page-shell">
    <div class="page-head">
        <div>
            <h2>WhatsApp (Evolution API)</h2>
            <div class="muted">Sessao externa: envio e status controlados pela Evolution API.</div>
        </div>
    </div>

    <div class="card" style="max-width:820px;">
        <div class="inline-actions" style="margin-bottom:12px;">
            <span class="badge success">Conectado a Evolution API</span>
        </div>
        <p class="muted">Nao e necessario exibir QR aqui. Use os botoes para enviar fila ou resetar a sessao.</p>
        <div class="page-actions">
            <button class="btn secondary" id="btn-send">Enviar fila agora</button>
            <button class="btn secondary" id="btn-reset">Resetar sessao</button>
            <span id="send-msg" class="muted"></span>
        </div>
    </div>
</div>
<form id="csrf-form">{% csrf_token %}</form>
<script>
const btnSend = document.getElementById('btn-send');
const btnReset = document.getElementById('btn-reset');
const sendMsg = document.getElementById('send-msg');
const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
let sendInterval = null;

btnSend.addEventListener('click', async () => {
    sendMsg.textContent = 'Iniciando envio...';
    try {
        const res = await fetch('{% url "whatsapp_send_now" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
        });
        const data = await res.json();
        sendMsg.textContent = data.message || 'Envio iniciado';
        if (data.started) {
            if (sendInterval) clearInterval(sendInterval);
            sendInterval = setInterval(checkWorker, 2000);
        }
    } catch (err) {
        sendMsg.textContent = 'Erro: ' + err.message;
    }
});

async function checkWorker() {
    try {
        const res = await fetch('{% url "whatsapp_worker_status" %}');
        const data = await res.json();
        if (!data.running) {
            sendMsg.textContent = 'Envio concluido.';
            clearInterval(sendInterval);
            sendInterval = null;
        } else {
            sendMsg.textContent = 'Envio em andamento...';
        }
    } catch (err) {
        sendMsg.textContent = 'Erro ao consultar envio: ' + err.message;
        clearInterval(sendInterval);
        sendInterval = null;
    }
}

btnReset.addEventListener('click', async () => {
    sendMsg.textContent = 'Reiniciando sessao...';
    try {
        await fetch('{% url "whatsapp_reset" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
        });
        sendMsg.textContent = 'Sessao reiniciada.';
    } catch (err) {
        sendMsg.textContent = 'Erro ao resetar: ' + err.message;
    }
});
</script>
{% endblock %}
