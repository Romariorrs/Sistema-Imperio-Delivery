{% extends "base.html" %}
{% block title %}Macros{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
    <h2>Macros - Leads coletados</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <a class="btn secondary" href="{% url 'macro_export_csv' %}?{{ filter_querystring }}">Exportar CSV</a>
        <a class="btn secondary" href="{% url 'macro_export_xlsx' %}?{{ filter_querystring }}">Exportar XLSX</a>
        <form method="post" action="{% url 'macro_import_csv' %}" enctype="multipart/form-data" style="display:flex;gap:8px;align-items:center;">
            {% csrf_token %}
            <input type="file" name="file" accept=".csv" required style="max-width:220px;">
            <button class="btn secondary" type="submit">Importar CSV</button>
        </form>
    </div>
</div>

<div class="card" style="margin-bottom:14px;">
    <h3 style="margin-bottom:8px;">Coleta por botoes (sem PowerShell)</h3>
    <p style="margin:0 0 8px;color:#9fb2d7;">
        1) No seu computador, de duplo clique em <b>iniciar_coletor_local.bat</b> (ou baixe os arquivos abaixo).
    </p>
    <p style="margin:0 0 8px;color:#9fb2d7;">
        2) Clique em "Abrir painel local" e use os botoes para abrir a pagina alvo, filtrar e iniciar coleta.
    </p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <a class="btn" href="{{ local_agent_url }}?api_url={{ api_import_url|urlencode }}&target_url={{ macro_target_url|urlencode }}" target="_blank" rel="noopener">Abrir painel local</a>
        <a class="btn secondary" href="{% url 'macro_download_local_agent_py' %}">Baixar local_macro_agent.py</a>
        <a class="btn secondary" href="{% url 'macro_download_local_agent_bat' %}">Baixar iniciar_coletor_local.bat</a>
    </div>
    <p style="margin:0 0 8px;color:#9fb2d7;">
        API usada para receber os dados:
    </p>
    <code style="display:block;word-break:break-all;margin-bottom:8px;">{{ api_import_url }}</code>
    {% if token_configured %}
        <p style="margin:0 0 8px;color:#9fb2d7;">Token de API configurado no sistema (MACRO_API_TOKEN).</p>
    {% else %}
        <p style="margin:0 0 8px;color:#ff6b6b;">MACRO_API_TOKEN nao configurado no .env.</p>
    {% endif %}
</div>

<div class="card" style="margin-bottom:12px;">
    <h3>Historico de execucoes</h3>
    <table>
        <thead>
            <tr>
                <th>Inicio</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>Recebidos</th>
                <th>Novos</th>
                <th>Atualizados</th>
                <th>IP</th>
                <th>Mensagem</th>
            </tr>
        </thead>
        <tbody>
        {% for run in recent_runs %}
            <tr>
                <td>{{ run.started_at|date:"d/m/Y H:i" }}</td>
                <td>{{ run.get_run_type_display }}</td>
                <td>{{ run.get_status_display }}</td>
                <td>{{ run.total_received }}</td>
                <td>{{ run.created_count }}</td>
                <td>{{ run.updated_count }}</td>
                <td>{{ run.request_ip|default:"-" }}</td>
                <td>{{ run.message|default:"-" }}</td>
            </tr>
        {% empty %}
            <tr><td colspan="8">Sem execucoes ainda.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="margin-bottom:12px;">
    <form method="get" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;align-items:end;">
        <div>
            <label>Busca geral</label>
            <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Nome, telefone, endereco...">
        </div>
        <div>
            <label>Cidade</label>
            <select name="city">
                <option value="">Todas</option>
                {% for value in cities %}
                    <option value="{{ value }}" {% if request.GET.city == value %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Status contrato</label>
            <select name="contract_status">
                <option value="">Todos</option>
                {% for value in contract_statuses %}
                    <option value="{{ value }}" {% if request.GET.contract_status == value %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Categoria</label>
            <select name="company_category">
                <option value="">Todas</option>
                {% for value in categories %}
                    <option value="{{ value }}" {% if request.GET.company_category == value %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn" type="submit">Filtrar</button>
            <a class="btn secondary" href="{% url 'macro_list' %}">Limpar</a>
        </div>
    </form>
</div>

<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h3>Total encontrado: {{ total_count }}</h3>
        <div style="color:#9fb2d7;">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Cidade</th>
                <th>Regiao</th>
                <th>Estabelecimento</th>
                <th>Representante</th>
                <th>Status</th>
                <th>Telefone</th>
                <th>Categoria</th>
                <th>Endereco</th>
                <th>Ultima captura</th>
            </tr>
        </thead>
        <tbody>
        {% for item in page_obj %}
            <tr>
                <td>{{ item.city }}</td>
                <td>{{ item.target_region }}</td>
                <td>{{ item.establishment_name }}</td>
                <td>{{ item.representative_name }}</td>
                <td>{{ item.contract_status }}</td>
                <td>{{ item.representative_phone }}</td>
                <td>{{ item.company_category }}</td>
                <td>{{ item.address }}</td>
                <td>{{ item.last_seen_at|date:"d/m/Y H:i" }}</td>
            </tr>
        {% empty %}
            <tr><td colspan="9">Nenhum dado importado ainda.</td></tr>
        {% endfor %}
        </tbody>
    </table>

    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
        {% if page_obj.has_previous %}
            <a class="btn secondary" href="?{% if filter_querystring %}{{ filter_querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
            <a class="btn secondary" href="?{% if filter_querystring %}{{ filter_querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Proxima</a>
        {% endif %}
    </div>
</div>
{% endblock %}
