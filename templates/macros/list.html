{% extends "base.html" %}
{% block title %}Macros - Banco de dados{% endblock %}
{% block extra_head %}
<style>
    .container {
        width: min(1720px, calc(100vw - 24px)) !important;
    }
    .macro-page {
        display: grid;
        gap: 14px;
        width: 100%;
        margin-inline: auto;
    }
    .macro-page > * { min-width: 0; }
    .macro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    .macro-title-wrap { display: flex; align-items: center; gap: 8px; }
    .macro-tag { font-size: 11px; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 3px 8px; }
    .macro-nav { display: flex; gap: 8px; flex-wrap: wrap; }
    .macro-nav .tab {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 12px;
        color: var(--muted);
        background: rgba(255,255,255,0.02);
    }
    .macro-nav .tab.active {
        color: #07111f;
        border-color: transparent;
        background: var(--accent);
        font-weight: 600;
    }
    .macro-orbit {
        --orbit-surface: rgba(22, 22, 22, 0.9);
        position: relative;
        isolation: isolate;
        overflow: hidden;
        border: 1px solid transparent !important;
    }
    .macro-orbit::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        background: conic-gradient(
            from 0deg,
            rgba(255, 132, 36, 0) 0deg,
            rgba(255, 132, 36, 0) 300deg,
            rgba(255, 132, 36, 0.95) 330deg,
            rgba(255, 132, 36, 0) 360deg
        );
        animation: macro-orbit-spin 2.6s linear infinite;
        z-index: -2;
    }
    .macro-orbit::after {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: inherit;
        background: var(--orbit-surface);
        z-index: -1;
    }
    .macro-nav .tab.macro-orbit {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .macro-nav .tab.macro-orbit.active {
        --orbit-surface: linear-gradient(180deg, #ff912e, #f97316);
        color: #091018;
        font-weight: 700;
    }
    .btn.macro-orbit {
        box-shadow: none;
        background: transparent !important;
    }
    .btn.secondary.macro-orbit {
        color: #efe8df;
    }
    .btn.macro-orbit:not(.secondary) {
        --orbit-surface: linear-gradient(180deg, #ff912e, #f97316);
        color: #fff;
    }
    @keyframes macro-orbit-spin {
        to { transform: rotate(1turn); }
    }
    .macro-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .macro-export-form {
        display: grid;
        gap: 12px;
        margin-top: 6px;
    }
    .macro-export-form-grid {
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr;
        gap: 12px;
        align-items: start;
    }
    .macro-export-fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
        max-height: 160px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: rgba(255,255,255,0.02);
    }
    .macro-export-fields label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin: 0;
        color: var(--text);
        text-transform: none;
        letter-spacing: .01em;
        font-weight: 500;
        font-size: 13px;
    }
    .macro-export-fields input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    .macro-export-limit-wrap input {
        width: 100%;
    }
    .macro-export-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }
    .macro-export-note {
        color: var(--muted);
        font-size: 12px;
        margin: 0;
    }
    .macro-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 10px; }
    .macro-kpi {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: linear-gradient(160deg, rgba(45,91,227,0.10), rgba(15,23,37,0.75));
    }
    .macro-kpi-label { color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .macro-kpi-value { font-size: 24px; font-weight: 600; line-height: 1.1; }
    .macro-kpi-note { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .macro-insights { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .macro-filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 10px; align-items: end; }
    .macro-filter-form > div:last-child { justify-self: end; }
    .macro-pagination { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .macro-danger-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
    .macro-danger-box { border: 1px dashed rgba(255, 107, 107, 0.45); border-radius: 12px; padding: 10px; }
    .macro-danger-title { margin: 0 0 6px; color: #ffb3b3; font-size: 13px; font-weight: 600; }
    .macro-danger-help { margin: 0 0 8px; color: var(--muted); font-size: 12px; }
    .macro-collapse-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }
    .macro-collapse-head h3 { margin: 0; }
    .macro-collapse-toggle {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color .2s ease, background .2s ease;
    }
    .macro-collapse-toggle:hover {
        border-color: rgba(255, 146, 66, 0.7);
        background: rgba(255, 146, 66, 0.08);
    }
    .macro-collapse-icon {
        width: 8px;
        height: 8px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg);
        transition: transform .2s ease;
        margin-top: -3px;
    }
    .macro-collapsible-content {
        display: none;
        margin-top: 10px;
    }
    .macro-collapsible-card.open .macro-collapsible-content {
        display: block;
    }
    .macro-collapsible-card.open .macro-collapse-icon {
        transform: rotate(-135deg);
        margin-top: 2px;
    }
    .macro-inline-form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .macro-inline-form input { width: auto; min-width: 140px; }
    .macro-row-blocked { background: rgba(255, 107, 107, 0.08); }
    .macro-phone-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 107, 107, 0.4);
        color: #ffb5b5;
        font-size: 12px;
        background: rgba(255, 107, 107, 0.13);
    }
    .macro-phone-chip.warn {
        border-color: rgba(255, 195, 77, 0.45);
        color: #ffd894;
        background: rgba(255, 195, 77, 0.16);
    }
    .macro-row-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .btn.ghost {
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none;
    }
    @media (max-width: 980px) {
        .macro-filter-form { grid-template-columns: 1fr; }
        .macro-filter-form > div:last-child { justify-self: start; }
        .macro-export-form-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}
{% block content %}
<div class="macro-page">
    <div class="macro-header">
        <div class="macro-title-wrap">
            <h2 style="margin:0;">Macros - Banco de dados</h2>
            <span class="macro-tag">{{ macro_agent_label }}</span>
        </div>
        <div class="macro-nav">
            <a class="tab macro-orbit {% if active_tab == 'database' %}active{% endif %}" href="{% url 'macro_list' %}">Banco de dados</a>
            <a class="tab macro-orbit {% if active_tab == 'collect' %}active{% endif %}" href="{% url 'macro_collect' %}">Coleta local</a>
        </div>
    </div>

    <div class="macro-actions">
        <a class="btn secondary macro-orbit" href="{% url 'macro_export_csv' %}?{{ filter_querystring }}">Exportar CSV</a>
        <a class="btn secondary macro-orbit" href="{% url 'macro_export_xlsx' %}?{{ filter_querystring }}">Exportar XLSX</a>
        <form method="post" action="{% url 'macro_import_csv' %}" enctype="multipart/form-data" style="display:flex;gap:8px;align-items:center;">
            {% csrf_token %}
            <input type="file" name="file" accept=".csv" required style="max-width:180px;">
            <button class="btn secondary macro-orbit" type="submit">Importar CSV</button>
        </form>
    </div>
    <div class="card">
        <h3 style="margin:0 0 8px;">Exportacao personalizada</h3>
        <form method="get" class="macro-export-form">
            <input type="hidden" name="q" value="{{ request.GET.q }}">
            <input type="hidden" name="city" value="{{ request.GET.city }}">
            <input type="hidden" name="contract_status" value="{{ request.GET.contract_status }}">
            <input type="hidden" name="business_99_status" value="{{ request.GET.business_99_status }}">
            <input type="hidden" name="company_category" value="{{ request.GET.company_category }}">
            <input type="hidden" name="blocked" value="{{ request.GET.blocked }}">
            <input type="hidden" name="phone_dup" value="{{ request.GET.phone_dup }}">
            <input type="hidden" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
            <input type="hidden" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
            <div class="macro-export-form-grid">
                <div class="macro-export-limit-wrap">
                    <label>Quantidade de leads</label>
                    <input type="number" name="export_limit" min="1" max="{{ max_export_limit }}" placeholder="vazio = todos filtrados">
                    <p class="macro-export-note">Limite maximo: {{ max_export_limit }} leads.</p>
                </div>
                <div>
                    <label>Colunas para exportar</label>
                    <div class="macro-export-fields">
                        {% for field, label in export_field_choices %}
                            <label>
                                <input type="checkbox" name="export_fields" value="{{ field }}" {% if field in default_export_fields %}checked{% endif %}>
                                <span>{{ label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="macro-export-buttons">
                <button class="btn secondary macro-orbit" type="submit" formaction="{% url 'macro_export_csv' %}">Exportar CSV personalizado</button>
                <button class="btn secondary macro-orbit" type="submit" formaction="{% url 'macro_export_xlsx' %}">Exportar XLSX personalizado</button>
            </div>
        </form>
    </div>

    <div class="card macro-collapsible-card" id="macroDataTools">
        <div class="macro-collapse-head">
            <h3>Gestao de dados</h3>
            <button class="macro-collapse-toggle" type="button" id="macroDataToolsBtn" aria-expanded="false" aria-controls="macroDataToolsContent" title="Mostrar/ocultar gestao de dados">
                <span class="macro-collapse-icon" aria-hidden="true"></span>
            </button>
        </div>
        <div class="macro-collapsible-content" id="macroDataToolsContent">
        <div class="macro-danger-grid">
            <div class="macro-danger-box">
                <div class="macro-danger-title">Excluir dados filtrados</div>
                <p class="macro-danger-help">Usa os filtros atuais da tela. Digite <b>EXCLUIR</b>.</p>
                <form method="post" action="{% url 'macro_delete_filtered' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                    <input type="hidden" name="city" value="{{ request.GET.city }}">
                    <input type="hidden" name="contract_status" value="{{ request.GET.contract_status }}">
                    <input type="hidden" name="business_99_status" value="{{ request.GET.business_99_status }}">
                    <input type="hidden" name="company_category" value="{{ request.GET.company_category }}">
                    <input type="hidden" name="blocked" value="{{ request.GET.blocked }}">
                    <input type="hidden" name="phone_dup" value="{{ request.GET.phone_dup }}">
                    <input type="hidden" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
                    <input type="hidden" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
                    <input type="text" name="confirm_text" placeholder="EXCLUIR" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Excluir os dados filtrados agora?')">Excluir filtrados</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Excluir apenas numeros bloqueados</div>
                <p class="macro-danger-help">Respeita os filtros atuais. Digite <b>EXCLUIR BLOQUEADOS</b>.</p>
                <form method="post" action="{% url 'macro_delete_blocked' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                    <input type="hidden" name="city" value="{{ request.GET.city }}">
                    <input type="hidden" name="contract_status" value="{{ request.GET.contract_status }}">
                    <input type="hidden" name="business_99_status" value="{{ request.GET.business_99_status }}">
                    <input type="hidden" name="company_category" value="{{ request.GET.company_category }}">
                    <input type="hidden" name="blocked" value="{{ request.GET.blocked }}">
                    <input type="hidden" name="phone_dup" value="{{ request.GET.phone_dup }}">
                    <input type="hidden" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
                    <input type="hidden" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
                    <input type="text" name="confirm_text" placeholder="EXCLUIR BLOQUEADOS" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Excluir apenas os bloqueados deste filtro?')">Excluir bloqueados</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Excluir toda base de leads</div>
                <p class="macro-danger-help">Apaga todo o banco de Macro. Digite <b>APAGAR TUDO</b>.</p>
                <form method="post" action="{% url 'macro_delete_all' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="database">
                    <input type="text" name="confirm_text" placeholder="APAGAR TUDO" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Tem certeza que deseja apagar toda a base de leads?')">Apagar base</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Limpar historico de execucoes</div>
                <p class="macro-danger-help">Remove os registros de execucao. Digite <b>LIMPAR HISTORICO</b>.</p>
                <form method="post" action="{% url 'macro_delete_runs' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="database">
                    <input type="text" name="confirm_text" placeholder="LIMPAR HISTORICO" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Limpar todo o historico de execucoes?')">Limpar historico</button>
                </form>
            </div>
            <div class="macro-danger-box">
                <div class="macro-danger-title">Excluir base especifica</div>
                <p class="macro-danger-help">Escolha a fonte e opcionalmente a cidade. Digite <b>EXCLUIR BASE</b>.</p>
                <form method="post" action="{% url 'macro_delete_source' %}" class="macro-inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="database">
                    <select name="source" required style="width:auto;min-width:140px;">
                        <option value="">Fonte</option>
                        {% for source in sources %}
                            <option value="{{ source }}">{{ source }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="city" placeholder="Cidade (opcional)">
                    <input type="text" name="confirm_text" placeholder="EXCLUIR BASE" required>
                    <button class="btn danger" type="submit" onclick="return confirm('Excluir base especifica agora?')">Excluir base especifica</button>
                </form>
            </div>
        </div>
        </div>
    </div>

    <div class="macro-kpis">
        <div class="macro-kpi">
            <div class="macro-kpi-label">Total de registros</div>
            <div class="macro-kpi-value">{{ stats.total_records }}</div>
            <div class="macro-kpi-note">Leads salvos no banco</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Quantidade de cidades</div>
            <div class="macro-kpi-value">{{ stats.total_cities }}</div>
            <div class="macro-kpi-note">Cidades diferentes</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Telefones preenchidos</div>
            <div class="macro-kpi-value">{{ stats.phones_filled }}</div>
            <div class="macro-kpi-note">Com numero informado</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Telefones unicos</div>
            <div class="macro-kpi-value">{{ stats.phones_unique }}</div>
            <div class="macro-kpi-note">Sem repeticao</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Numeros bloqueados</div>
            <div class="macro-kpi-value">{{ stats.blocked_numbers }}</div>
            <div class="macro-kpi-note">Unicos: {{ stats.blocked_numbers_unique }}</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Numeros duplicados</div>
            <div class="macro-kpi-value">{{ stats.duplicate_phone_numbers }}</div>
            <div class="macro-kpi-note">Leads com duplicidade: {{ stats.duplicate_phone_leads }}</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Categorias cadastradas</div>
            <div class="macro-kpi-value">{{ stats.total_categories }}</div>
            <div class="macro-kpi-note">Tipos de culinaria/empresa</div>
        </div>
        <div class="macro-kpi">
            <div class="macro-kpi-label">Ultimo dia puxado</div>
            <div class="macro-kpi-value">
                {% if last_capture_at %}
                    {{ last_capture_at|date:"d/m/Y H:i" }}
                {% else %}
                    --
                {% endif %}
            </div>
            <div class="macro-kpi-note">
                {% if last_success_run %}
                    Ultima execucao: {{ last_success_run.started_at|date:"d/m/Y H:i" }}
                {% else %}
                    Sem execucao registrada
                {% endif %}
            </div>
        </div>
    </div>

    <div class="macro-insights">
        <div class="card">
            <h3 style="margin:0;">Top cidades</h3>
            <table>
                <thead><tr><th>Cidade</th><th>Quantidade</th></tr></thead>
                <tbody>
                {% for row in city_breakdown %}
                    <tr><td>{{ row.city }}</td><td>{{ row.total }}</td></tr>
                {% empty %}
                    <tr><td colspan="2">Sem dados.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card">
            <h3 style="margin:0;">Top culinarias/categorias</h3>
            <table>
                <thead><tr><th>Categoria</th><th>Quantidade</th></tr></thead>
                <tbody>
                {% for row in category_breakdown %}
                    <tr><td>{{ row.company_category }}</td><td>{{ row.total }}</td></tr>
                {% empty %}
                    <tr><td colspan="2">Sem dados.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card">
            <h3 style="margin:0;">Status do contrato</h3>
            <table>
                <thead><tr><th>Status</th><th>Quantidade</th></tr></thead>
                <tbody>
                {% for row in status_breakdown %}
                    <tr><td>{{ row.contract_status }}</td><td>{{ row.total }}</td></tr>
                {% empty %}
                    <tr><td colspan="2">Sem dados.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card">
            <h3 style="margin:0;">Seu Negocio na 99</h3>
            <table>
                <thead><tr><th>Status</th><th>Quantidade</th></tr></thead>
                <tbody>
                {% for row in business_99_breakdown %}
                    <tr><td>{{ row.business_99_status }}</td><td>{{ row.total }}</td></tr>
                {% empty %}
                    <tr><td colspan="2">Sem dados.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card macro-collapsible-card" id="macroRunHistory">
        <div class="macro-collapse-head">
            <h3>Historico de execucoes</h3>
            <button class="macro-collapse-toggle" type="button" id="macroRunHistoryBtn" aria-expanded="false" aria-controls="macroRunHistoryContent" title="Mostrar/ocultar historico de execucoes">
                <span class="macro-collapse-icon" aria-hidden="true"></span>
            </button>
        </div>
        <div class="macro-collapsible-content" id="macroRunHistoryContent">
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Inicio</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Coletados</th>
                        <th>Unicos</th>
                        <th>Enviados</th>
                        <th>Novos</th>
                        <th>Atualizados</th>
                        <th>Paginas</th>
                        <th>IP</th>
                        <th>Mensagem</th>
                        <th>Acoes</th>
                    </tr>
                </thead>
                <tbody>
                {% for run in recent_runs %}
                    <tr>
                        <td>{{ run.started_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ run.get_run_type_display }}</td>
                        <td>{{ run.get_status_display }}</td>
                        <td>{{ run.total_collected }}</td>
                        <td>{% if run.total_deduplicated %}{{ run.total_deduplicated }}{% else %}{{ run.total_received }}{% endif %}</td>
                        <td>{% if run.total_sent %}{{ run.total_sent }}{% else %}{{ run.total_received }}{% endif %}</td>
                        <td>{{ run.created_count }}</td>
                        <td>{{ run.updated_count }}</td>
                        <td>{{ run.pages_processed|default:"0" }}</td>
                        <td>{{ run.request_ip|default:"-" }}</td>
                        <td>{{ run.message|default:"-" }}</td>
                        <td>
                            <form method="post" action="{% url 'macro_delete_run_item' run.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="database">
                                <button class="btn danger" type="submit" onclick="return confirm('Excluir esta execucao do historico?')">Excluir</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="12">Sem execucoes ainda.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Consulta detalhada</h3>
        <form method="get" class="macro-filter-form">
            <div>
                <label>Busca geral</label>
                <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Nome, telefone, endereco...">
            </div>
            <div>
                <label>Cidade</label>
                <select name="city">
                    <option value="">Todas</option>
                    {% for value in cities %}
                        <option value="{{ value }}" {% if request.GET.city == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Status contrato</label>
                <select name="contract_status">
                    <option value="">Todos</option>
                    {% for value in contract_statuses %}
                        <option value="{{ value }}" {% if request.GET.contract_status == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Seu Negocio na 99</label>
                <select name="business_99_status">
                    <option value="">Todos</option>
                    {% for value in business_99_statuses %}
                        <option value="{{ value }}" {% if request.GET.business_99_status == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Categoria</label>
                <select name="company_category">
                    <option value="">Todas</option>
                    {% for value in categories %}
                        <option value="{{ value }}" {% if request.GET.company_category == value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Numeros bloqueados</label>
                <select name="blocked">
                    <option value="" {% if not request.GET.blocked %}selected{% endif %}>Todos</option>
                    <option value="yes" {% if request.GET.blocked == "yes" %}selected{% endif %}>Somente bloqueados</option>
                    <option value="no" {% if request.GET.blocked == "no" %}selected{% endif %}>Somente desbloqueados</option>
                </select>
            </div>
            <div>
                <label>Duplicidade de numero</label>
                <select name="phone_dup">
                    <option value="" {% if not request.GET.phone_dup %}selected{% endif %}>Todos</option>
                    <option value="duplicates" {% if request.GET.phone_dup == "duplicates" %}selected{% endif %}>Somente duplicados</option>
                    <option value="unique" {% if request.GET.phone_dup == "unique" %}selected{% endif %}>Somente unicos</option>
                    <option value="empty" {% if request.GET.phone_dup == "empty" %}selected{% endif %}>Sem telefone</option>
                </select>
            </div>
            <div>
                <label>Lead de (data)</label>
                <input type="date" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
            </div>
            <div>
                <label>Lead ate (data)</label>
                <input type="date" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn macro-orbit" type="submit">Filtrar</button>
                <a class="btn secondary macro-orbit" href="{% url 'macro_list' %}">Limpar</a>
            </div>
        </form>
    </div>

    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
            <h3 style="margin:0;">Resultados filtrados: {{ filtered_count }}</h3>
            <div style="color:#9fb2d7;">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Cidade</th>
                        <th>Regiao</th>
                        <th>Estabelecimento</th>
                        <th>Representante</th>
                        <th>Status</th>
                        <th>Seu Negocio na 99</th>
                        <th>Telefone</th>
                        <th>Categoria</th>
                        <th>Endereco</th>
                        <th>Horario lead</th>
                        <th>Ultima captura</th>
                        <th>Acoes</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in page_obj %}
                    <tr class="{% if item.is_blocked_number %}macro-row-blocked{% endif %}">
                        <td>{{ item.city }}</td>
                        <td>{{ item.target_region }}</td>
                        <td>{{ item.establishment_name }}</td>
                        <td>{{ item.representative_name }}</td>
                        <td>{{ item.contract_status }}</td>
                        <td>{{ item.business_99_status|default:"--" }}</td>
                        <td>
                            {{ item.representative_phone|default:"--" }}
                            {% if item.is_blocked_number %}
                                <span class="macro-phone-chip">Bloqueado</span>
                            {% endif %}
                            {% if item.representative_phone_norm and item.representative_phone_norm in page_duplicate_phone_norms %}
                                <span class="macro-phone-chip warn">Duplicado</span>
                            {% endif %}
                        </td>
                        <td>{{ item.company_category }}</td>
                        <td>{{ item.address }}</td>
                        <td>
                            {% if item.lead_created_at %}
                                {{ item.lead_created_at|date:"d/m/Y H:i" }}
                            {% else %}
                                --
                            {% endif %}
                        </td>
                        <td>{{ item.last_seen_at|date:"d/m/Y H:i" }}</td>
                        <td>
                            <div class="macro-row-actions">
                                {% if item.is_blocked_number %}
                                    <form method="post" action="{% url 'macro_unblock_phone' item.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                                        <input type="hidden" name="city" value="{{ request.GET.city }}">
                                        <input type="hidden" name="contract_status" value="{{ request.GET.contract_status }}">
                                        <input type="hidden" name="business_99_status" value="{{ request.GET.business_99_status }}">
                                        <input type="hidden" name="company_category" value="{{ request.GET.company_category }}">
                                        <input type="hidden" name="blocked" value="{{ request.GET.blocked }}">
                                        <input type="hidden" name="phone_dup" value="{{ request.GET.phone_dup }}">
                                        <input type="hidden" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
                                        <input type="hidden" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
                                        <button class="btn ghost" type="submit">Desbloquear</button>
                                    </form>
                                {% else %}
                                    <form method="post" action="{% url 'macro_block_phone' item.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                                        <input type="hidden" name="city" value="{{ request.GET.city }}">
                                        <input type="hidden" name="contract_status" value="{{ request.GET.contract_status }}">
                                        <input type="hidden" name="business_99_status" value="{{ request.GET.business_99_status }}">
                                        <input type="hidden" name="company_category" value="{{ request.GET.company_category }}">
                                        <input type="hidden" name="blocked" value="{{ request.GET.blocked }}">
                                        <input type="hidden" name="phone_dup" value="{{ request.GET.phone_dup }}">
                                        <input type="hidden" name="lead_date_from" value="{{ request.GET.lead_date_from }}">
                                        <input type="hidden" name="lead_date_to" value="{{ request.GET.lead_date_to }}">
                                        <button class="btn danger" type="submit">Bloquear</button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="12">Nenhum dado encontrado.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="macro-pagination">
            {% if page_obj.has_previous %}
                <a class="btn secondary" href="?{% if filter_querystring %}{{ filter_querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            {% endif %}
            {% if page_obj.has_next %}
                <a class="btn secondary" href="?{% if filter_querystring %}{{ filter_querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Proxima</a>
            {% endif %}
        </div>
    </div>
</div>
<script>
(() => {
    const initCollapse = (cardId, btnId, storageKey) => {
        const card = document.getElementById(cardId);
        const btn = document.getElementById(btnId);
        if (!card || !btn) return;

        const saved = localStorage.getItem(storageKey);
        const open = saved === "1";

        const applyState = (isOpen) => {
            card.classList.toggle("open", isOpen);
            btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        };

        applyState(open);

        btn.addEventListener("click", () => {
            const next = !card.classList.contains("open");
            applyState(next);
            localStorage.setItem(storageKey, next ? "1" : "0");
        });
    };

    initCollapse("macroDataTools", "macroDataToolsBtn", "macro_data_tools_open");
    initCollapse("macroRunHistory", "macroRunHistoryBtn", "macro_run_history_open");
})();
</script>
{% endblock %}
